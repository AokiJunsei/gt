<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Directions Service</title>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map-container {
      position: relative;
      height: 100vh;
    }

    #map {
      height: 100%;
    }

    #directions-panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 30%;
      max-height: 100vh;
      overflow-y: auto;
      background-color: #fff;
      padding: 10px;
      box-sizing: border-box;
      transition: width 0.3s ease;
    }

    #directions-panel.collapsed {
      width: 0;
    }

    #floating-panel {
      position: absolute;
      top: 10px;
      left: 35%; /* Adjusted position */
      z-index: 5;
      background-color: #fff;
      padding: 5px;
      border: 1px solid #999;
      text-align: center;
      font-family: "Roboto", "sans-serif";
      line-height: 30px;
      padding-left: 10px;
    }

    .mode-selector {
      margin-top: 10px;
    }

    .tab {
      display: inline-block;
      padding: 10px;
      cursor: pointer;
    }

    .tab-content {
      display: none;
    }

    .active {
      display: block;
    }
  </style>
  <!-- Font Awesome icons (free version)-->
  <!-- <script src="https://use.fontawesome.com/releases/v5.15.4/js/all.js"></script> -->
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
</head>
<body onload="initMap()">

  <div id="floating-panel">
    <!-- <h1>最短検索</h1> -->
    <b>出発地: </b>
    <input type="text" id="start" placeholder="Enter start location" />
    <button onclick="getCurrentLocation()">現在地</button><br>
    <b>中継地点１: </b>
    <input type="text" id="waypoint1" placeholder="Enter waypoint location 1" />
    <b>中継地点２: </b>
    <input type="text" id="waypoint2" placeholder="Enter waypoint location 2" /><br>
    <b>到着地: </b>
    <input type="text" id="end" placeholder="Enter end location" />
    <button onclick="swapStartEnd()">入れ替える</button>
    <b>出発時間: </b>
    <input type="date" id="departure-date" />
    <input type="time" id="departure-time" />

    <button onclick="calculateAndDisplayRoute()">検索する</button>
    <button onclick="toggleDirectionsPanel()">←</button>

    <div class="mode-selector">
      <input type="checkbox" id="mode-driving" checked />
      <label for="mode-driving">自動車</label>

      <input type="checkbox" id="mode-transit"  />
      <label for="mode-transit">電車</label>

      <input type="checkbox" id="mode-walking"  />
      <label for="mode-walking">徒歩</label>

      <input type="checkbox" id="mode-bicycling"  />
      <label for="mode-bicycling">自転車</label>
    </div>
    <span hidden><div id="id_ido">緯度</div></span>
    <span hidden><div id="id_keido">経度</div></span>
    <span hidden><div id="id_address">住所</div></span>
  </div>
  <div id="map-container">
    <div id="map"></div>
    <div id="directions-panel">
      <div class="tab" onclick="toggleTab('content')">Content</div>
      <div class="tab" onclick="toggleTab('details')">Details</div>
      <div id="content-tab" class="tab-content active"></div>
      <div id="details-tab" class="tab-content"></div>
    </div>
    <!-- <div id="map_canvas" style="width:100%;height:300px"></div> -->
  </div>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5diRbD4Ex24SsS0_YISzQW5f19mckhf4&callback=initMap&v=weekly"
    defer
  ></script>

  <script>
    let map, directionsService, directionsRenderer;
    let currentLocationMarker;

    //マップ情報
    function initMap() {
      var Marker;
      const initial_location = { lat: 35.689, lng: 139.692 };

      /*現在地更新を5000秒ごとに繰り返す*/
      /*setInterval(updateCurrentLocation, 5000);*/

      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 17,
        center: initial_location,
      });

      /*情報ウィンドウの中身のHTML*/
      const contentString =
      '<div id="content">' +
        '<div id="siteNotice">' +
        "</div>" +
        '<h1 id="firstHeading" class="firstHeading"></h1>' +
        '<div id="bodyContent">' +
        "<p><b>自宅</b>, also referred to as <b>Ayers Rock</b>, is a large " +
        "sandstone rock formation in the southern part of the " +
        "Northern Territory, central Australia. It lies 335&#160;km (208&#160;mi) " +
        "south west of the nearest large town, Alice Springs; 450&#160;km " +
        "(280&#160;mi) by road. Kata Tjuta and initial_location are the two major " +
        "features of the initial_location - Kata Tjuta National Park. initial_location is " +
        "sacred to the Pitjantjatjara and Yankunytjatjara, the " +
        "Aboriginal people of the area. It has many springs, waterholes, " +
        "rock caves and ancient paintings. initial_location is listed as a World " +
        "Heritage Site.</p>" +
        '<p>Attribution: initial_location, <a href="https://en.wikipedia.org/w/index.php?title=initial_location&oldid=297882194">' +
        "https://en.wikipedia.org/w/index.php?title=initial_location</a> " +
        "(last visited June 22, 2009).</p>" +
        "</div>" +
        "</div>";

      const infoWindow = new google.maps.InfoWindow({
        /*情報ウィンドウの中身の文字列を取得　contentStrings*/
        content: contentString,
        ariaLabel: "initial_location",
      });
      const marker = new google.maps.Marker({
        position: initial_location,
        map,
        title: "initial_location (Ayers Rock)",
      });

      marker.addListener("click", () => {
        infoWindow.open({
          anchor: marker,
          map,
        });
      });

      //マーカー場所(EV車や電動キックボード)の表示
      const trafficLayer = new google.maps.TrafficLayer();
      const iconBase =
        "https://developers.google.com/maps/documentation/javascript/examples/full/images/";
      const icons = {
        parking: {
          icon: iconBase + "parking_lot_maps.png",
        },
        library: {
          icon: iconBase + "library_maps.png",
        },
        info: {
          icon: iconBase + "info-i_maps.png",
        },
      };

      const features = [
        {
          position: new google.maps.LatLng(35.5737851, 139.7626623),
          type: "library",
        },
        {
          position: new google.maps.LatLng(35.5637851, 139.7626623),
          type: "parking",
        },
        {
          position: new google.maps.LatLng(35.5937851, 139.7626623),
          type: "info",
        }
        ];

      // マーカー作成.
      for (let i = 0; i < features.length; i++) {
        const marker = new google.maps.Marker({
          position: features[i].position,
          icon: icons[features[i].type].icon,
          map: map,
        });
      }
      trafficLayer.setMap(map);

      //検索結果を左のタブに表示
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        panel: document.getElementById("content-tab"),
      });

      //地図クリックイベントの登録
      google.maps.event.addListener(map, 'click',
        function(event) {
          if (Marker){Marker.setMap(null)};
          Marker = new google.maps.Marker({
          position: event.latLng,
          draggable: true,
          map: map
        });
        infotable(Marker.getPosition().lat(),
        Marker.getPosition().lng(),map.getZoom());
        geocode();
        //マーカードラッグイベントの登録
        google.maps.event.addListener(Marker,'dragend',
        function(event) {
        infotable(Marker.getPosition().lat(),
        Marker.getPosition().lng(),map.getZoom());
        geocode();
        })
        //地図ズームチェンジイベントの登録
        google.maps.event.addListener(map, 'zoom_changed',
        function(event) {
        infotable(Marker.getPosition().lat(),
        Marker.getPosition().lng(),map.getZoom());
        })
      })

      //ジオコーディング
      function geocode(){  var geocoder = new google.maps.Geocoder();
        geocoder.geocode({ 'location': Marker.getPosition()},
          function(results, status) {
        if (status == google.maps.GeocoderStatus.OK && results[0]){
          document.getElementById('id_address').innerHTML =
              results[0].formatted_address.replace(/^日本, /, '');
        }else{
          document.getElementById('id_address').innerHTML =
            "Geocode 取得に失敗しました";
          alert("Geocode 取得に失敗しました reason: "
                + status);
        }
        });
      }

     //HTMLTagを更新
      function infotable(ido,keido,level){
        document.getElementById('id_ido').innerHTML = ido;
        document.getElementById('id_keido').innerHTML = keido;
        document.getElementById('id_address').innerHTML = level;
        document.getElementById("waypoint1").value =   ido + ","+ keido;
      }

    }

    /*上記までがinitMap()*/

    /*現在地を出発地に指定*/
    function getCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const currentLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            // Set center and add marker
            map.setCenter(currentLocation);
            addCurrentLocationMarker(currentLocation);

            // Set the start input value
            //document.getElementById("start").value = "現在地" ;
            document.getElementById("start").value = currentLocation.lat + ", " + currentLocation.lng;
          },
          () => {
            console.error("Error getting current location");
          }
        );
      } else {
        console.error("Geolocation is not supported by this browser");
      }
    }

    /*現在地に常時ピン差し一回目*/
    function addCurrentLocationMarker(location) {
      // Remove existing marker if any
      if (currentLocationMarker) {
        currentLocationMarker.setMap(null);
      }

      // Add marker
      currentLocationMarker = new google.maps.Marker({
        position: location,
        map: map,
        title: "Current Location",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: "#4285F4",
          fillOpacity: 1,
          strokeColor: "#ffffff",
          strokeWeight: 2,
        },
      });
    }

    /*現在地を取得しマーカーを置く(2回目以降)*/
    function updateCurrentLocationMarker(location) {
      // If the marker doesn't exist, create it
      if (!currentLocationMarker) {
        currentLocationMarker = new google.maps.Marker({
          map: map,
          title: "Current Location",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: "#4285F4",
            fillOpacity: 1,
            strokeColor: "#ffffff",
            strokeWeight: 2,
          },
        });
      }

      /*更新された現在地をマーカーにセットする*/
      currentLocationMarker.setPosition(location);

      /*地図の中央地を更新された現在地に変更する*/
      map.setCenter(location);
    }

    /*経路検索メソッド*/
    function calculateAndDisplayRoute() {
      const start = document.getElementById("start").value;
      const waypoint1 = document.getElementById("waypoint1").value;
      const waypoint2 = document.getElementById("waypoint2").value;
      const end = document.getElementById("end").value;
      const departureTime = document.getElementById("departure-date").value;

      const drivingMode = document.getElementById("mode-driving").checked;
      // const transitMode = document.getElementById("mode-transit").checked;
      const walkingMode = document.getElementById("mode-walking").checked;
      const bicyclingMode = document.getElementById("mode-bicycling").checked;

      const travelModes = [];
      if (drivingMode) travelModes.push(google.maps.TravelMode.DRIVING);
      // if (transitMode) travelModes.push(google.maps.TravelMode.TRANSIT);
      if (walkingMode) travelModes.push(google.maps.TravelMode.WALKING);
      if (bicyclingMode) travelModes.push(google.maps.TravelMode.BICYCLING);

      const request = {
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.DRIVING, // Default mode
      };

      if (waypoint1) {
        request.waypoints = [{ location: waypoint1 }];
      }
      if (waypoint2) {
        if (!request.waypoints) request.waypoints = [];
        request.waypoints.push({ location: waypoint2 });
      }
      if (travelModes.length > 0) {
        request.travelMode = travelModes[0];
        request.transitOptions = {
          modes: travelModes.slice(1),
          departureTime: new Date(departureTime),
        };
      }

      directionsService.route(request, (response, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(response);
          showRouteInformation(response);
        } else {
          window.alert("Directions request failed due to " + status);
        }
      });
    }

    /*検索結果をinnerHTMLで記載*/
    function showRouteInformation(response) {
      const directionsPanel = document.getElementById("details-tab");
      directionsPanel.innerHTML = "";

      for (let i = 0; i < response.routes.length; i++) {
        const route = response.routes[i];

        const summary = document.createElement("div");
        summary.innerHTML = `<b>${route.summary}</b>`;
        directionsPanel.appendChild(summary);

        const steps = route.legs[0].steps;
        for (let j = 0; j < steps.length; j++) {
          const stepInfo = document.createElement("div");
          stepInfo.innerHTML = steps[j].instructions;
          directionsPanel.appendChild(stepInfo);
        }
      }
    }

    /*検索結果のタブの開閉*/
    function toggleDirectionsPanel() {
      const directionsPanel = document.getElementById("directions-panel");
      directionsPanel.classList.toggle("collapsed");
    }

    function toggleTab(tabName) {
      const contentTab = document.getElementById("content-tab");
      const detailsTab = document.getElementById("details-tab");

      if (tabName === "content") {
        contentTab.classList.add("active");
        detailsTab.classList.remove("active");
      } else {
        contentTab.classList.remove("active");
        detailsTab.classList.add("active");
      }
    }

    /*出発地と到着地の内容を入れ替える関数*/
    function swapStartEnd() {
      const startInput = document.getElementById("start");
      const endInput = document.getElementById("end");

      // 入れ替えボタン
      const temp = startInput.value;
      startInput.value = endInput.value;
      endInput.value = temp;
    }

    /*リアルタイムで現在地を取得する*/
    function updateCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const currentLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            /* 現在地のピンを打つ*/
            updateCurrentLocationMarker(currentLocation);
          },
          () => {
            console.error("Error getting current location");
          }
        );
      } else {
        console.error("Geolocation is not supported by this browser");
      }
    }
  </script>

  <script>
    /*電車が選択されたときに動く関数*/
    document.addEventListener('DOMContentLoaded', function() {
        var checkbox = document.getElementById('mode-transit');
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                /*デバックの為一次コメントアウト*/
                /*fetchRouteAndDisplayOnMap();*/
                displayRouteOnMap();
            }
        });
    });


    /*電車が選択された際にAPIをfetchする関数*/
    /*function fetchRouteAndDisplayOnMap() {
      const start = document.getElementById("start").value;
      const waypoint1 = document.getElementById("waypoint1").value;
      const waypoint2 = document.getElementById("waypoint2").value;
      const end = document.getElementById("end").value;
      const departureDateInput = document.getElementById("departure-date").value;
      const departureTimeInput = document.getElementById("departure-time").value;

     // 日付をyyyymmdd形式に変換
      const departureDate = departureDateInput.split('-').join('');
     // 時間をhhmm形式に変換
      const departureTime = departureTimeInput.split(':').join('');
      const queryParams = {
        //APIリクエストに必要なパラメータ
        f : 1,
        rm : 'sr',
        eki1 : start,
        eki2 : end,
        kbn1 : 'R',
        date : departureDate,
        time : departureTime,
        opt1 : 0,
        opt2 : 0,
        opt3 : 1,
        opt4 : 0,
        max : 8,
        sort : 0,
        trtm : 3
      }
      const queryString = new URLSearchParams(queryParams).toString();
      const url = `https://cloud.jorudan.biz/api/gv?ak=J2vqRoi1ciaJzktP&${queryString}`;

      fetch(url,{
        method : 'GET',
      })
      .then(response => {
        if(!response.ok){
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        //取得したルート情報を地図上に表示する
        //displayRouteOnMap(data);
        alert(JSON.stringify(data,null,2));
      })
      .catch(error => {
        console.error('Error:',error)
      });
    }*/

    var routeData = {
      "NorikaeBizApiResult":{
          "head":{
              "functionCode":"sr",
              "errorCode":"0"
          },
          "body":{
              "num":"1",
              "storeData":"",
              "route":[{
                  "id":"1",
                  "hyouka":{
                      "pathCnt":"2",
                      "jikan":"21",
                      "hiyou":"220",
                      "icExist":"1",
                      "icHiyou":"216",
                      "kyori":"118",
                      "norikaeCnt":"0",
                      "status":{
                          "hayai":"1",

                          "yasui":"1",
                          "raku":"1",
                          "kuuro":"0",
                          "shindai":"0",
                          "kousoku":"0",
                          "icCard":"1",
                          "norikae":"1",
                          "co2":"0",
                          "syubetu":"0",
                          "icYasui":"1",
                          "value":"1,1,1,0,0,0,1,1,0,0,1"
                      },
                      "kubun":{
                          "shinkansen":"0",
                          "nozomi":"0",
                          "tokkyu":"0",
                          "shindai":"0",
                          "kuuro":"0",
                          "bus":"0",
                          "kousoku":"0",
                          "renraku":"0",
                          "shinya":"0",
                          "ferry":"0",
                          "toho":"0",
                          "yuryou":"0",
                          "jr":"1",
                          "value":"0,0,0,0,0,0,0,0,0,0,0,0,1"
                      }
                  },
              "path":[{
                  "id":"1",
                  "rosen":"中央線",
                  "rosenSyubetu":"0",
                  "from":"荻窪",
                  "fromExt":"",
                  "to":"新宿",
                  "toExt":"",
                  "kyori":"84",
                  "jikan":"10",
                  "mati":"0",
                  "idou":"3",
                  "norikae":"0",
                  "direction":"0",
                  "seatName":"",
                  "seatCode":"",
                  "seatKubun":{
                      "num":"0"
                  },
                  "untin":"220",
                  "untinOufuku":"0",
                  "untinTuusan":"1",
                  "tokkyu":"0",
                  "tokkyuGreen":"0",
                  "tokkyuShindai":"0",
                  "tokkyuKisetu":"-1",
                  "tokkyuWaribiki":"0",
                  "tokkyuTuusan":"0",
                  "icExist":"1",
                  "icUntin":"216",
                  "icUntinTuusan":"1",
                  "icTokkyu":"0",
                  "icTokkyuGreen":"0",
                  "icTokkyuTuusan":"0",
                  "airLine":"",
                  "fromDate":"00000000",
                  "fromTime":"",
                  "fromTimeType":"-1",
                  "toDate":"00000000",
                  "toTime":"",
                  "toTimeType":"-1",
                  "lineName":"",
                  "lineType":"快速",
                  "lineIndex":"-1",
                  "selectLine":"",

                  "lineColor":{
                      "type":"0",
                      "num":"1",
                      "rgb":[
                          "ffa500"
                      ]
                  },
                  "haveDiagram":"1",
                  "useDiagram":"0",
                  "rosenCorp":"ＪＲ",
                  "busCorp":"",
                  "josyaText":"3・5・8・10 号車",
                  "fromPlatform":"",
                  "toPlatform":"",
                  "tokurei":{
                      "data":"256",
                      "num":"1",
                      "info":[{
                          "code":"U_PASMOBETU",
                          "name":"ＩＣカード別運賃",
                          "text":"券売機や窓口できっぷを購入した場合の運賃です。IC カードを使用した場合とは異なります。",
                          "id":"1"
                      }]
                  },
                  "icTokurei":{
                      "data":"512",
                      "num":"1",
                      "info":[{
                          "code":"U_PASMO",
                          "name":"ＩＣカード運賃",
                          "text":"IC カードを使用した場合の運賃です。券売機で購入した場合とは異なります。",
                          "id":"1"
                      }]
                  },
                  "co2":"151",
                  "fromX":"139,37,24,400",
                  "fromY":"35,42,4,400",
                  "toX":"139,42,13,400",
                  "toY":"35,41,12,900"
                  }]
              }]
          }
      }}

    /*取得したルート情報を地図上に表示する関数*/
    function displayRouteOnMap(routeData) {
      var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12,
          center: { lat: 35.6895, lng: 139.6917 } // 初期中心点を設定（例: 東京）
      });

      var bounds = new google.maps.LatLngBounds();
      var routePath = new google.maps.Polyline({
          path: [],
          geodesic: true,
          strokeColor: '#FF0000',
          strokeOpacity: 1.0,
          strokeWeight: 2,
          map: map
      });

      routeData.NorikaeBizApiResult.body.route.forEach(function(route) {
          route.path.forEach(function(segment) {
              var from = convertToLatLng(segment.fromX, segment.fromY);
              var to = convertToLatLng(segment.toX, segment.toY);

              // ポリラインのパスに座標を追加
              routePath.getPath().push(from);
              routePath.getPath().push(to);

              // マーカーを設置
              new google.maps.Marker({ position: from, map: map });
              new google.maps.Marker({ position: to, map: map });

              // boundsに座標を追加
              bounds.extend(from);
              bounds.extend(to);
          });
      });

      // マップのビューポートを調整
      map.fitBounds(bounds);
    }

    function convertToLatLng(x, y) {
        // x, yの値を緯度経度に変換する処理
        // 例: '139,37,24,400' → { lat: 35.6895, lng: 139.6917 }
        // 注意: 実際の変換ロジックは、x, yの形式に基づいて実装する必要があります
    }
  </script>
</body>
</html>