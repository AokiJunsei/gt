<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Directions Service</title>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map-container {
      position: relative;
      height: 100vh;
    }

    #map {
      height: 100%;
    }

    #directions-panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 30%;
      max-height: 100vh;
      overflow-y: auto;
      background-color: #fff;
      padding: 10px;
      box-sizing: border-box;
      transition: width 0.3s ease;
    }

    #directions-panel.collapsed {
      width: 0;
    }

    #floating-panel {
      position: absolute;
      top: 10px;
      left: 35%; /* 調整した位置 */
      z-index: 5;
      background-color: #fff;
      padding: 5px;
      border: 1px solid #999;
      text-align: center;
      font-family: "Roboto", "sans-serif";
      line-height: 30px;
      padding-left: 10px;
    }

    .mode-selector {
      margin-top: 10px;
    }

    .tab {
      display: inline-block;
      padding: 10px;
      cursor: pointer;
    }

    .tab-content {
      display: none;
    }

    .active {
      display: block;
    }
  </style>
</head>
<body onload="initMap()">
  <div id="floating-panel">
    <b>Start: </b>
    <input type="text" id="start" placeholder="Enter start location" />
    <b>Waypoint 1: </b>
    <input type="text" id="waypoint1" placeholder="Enter waypoint location 1" />
    <b>Waypoint 2: </b>
    <input type="text" id="waypoint2" placeholder="Enter waypoint location 2" />
    <b>End: </b>
    <input type="text" id="end" placeholder="Enter end locati" />
    <b>Departure Time: </b>
    <input type="datetime-local" id="departure-time" />
    <button onclick="getCurrentLocation()">Use Current Location</button>
    <button onclick="calculateAndDisplayRoute()">Search</button>
    <button onclick="toggleDirectionsPanel()">Toggle Panel</button>

    <div class="mode-selector">
      <input type="checkbox" id="mode-driving" checked />
      <label for="mode-driving">Driving</label>

      <input type="checkbox" id="mode-transit"  />
      <label for="mode-transit">Transit</label>

      <input type="checkbox" id="mode-walking"  />
      <label for="mode-walking">Walking</label>

      <input type="checkbox" id="mode-bicycling"  />
      <label for="mode-bicycling">Bicycling</label>
    </div>
    <span hidden><div id="id_ido">緯度</div></span>
    <span hidden><div id="id_keido">経度</div></span>
    <span hidden><div id="id_address">住所</div></span>
  </div>
  <div id="map-container">
    <div id="map"></div>
    <div id="directions-panel">
      <div class="tab" onclick="toggleTab('content')">Content</div>
      <div class="tab" onclick="toggleTab('details')">Details</div>
      <div id="content-tab" class="tab-content active"></div>
      <div id="details-tab" class="tab-content"></div>
    </div>
  <!-- <div id="map_canvas" style="width:100%;height:300px"></div> -->
</div>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5diRbD4Ex24SsS0_YISzQW5f19mckhf4&callback=initMap&v=weekly"
    defer
  ></script>
  <script>
    let map, directionsService, directionsRenderer;
    let currentLocationMarker;

    function initMap() {
      var Marker;

      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 7,
        center: { lat: 35.689, lng: 139.692 },
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        panel: document.getElementById("content-tab"),
      });
      //地図クリックイベントの登録
      google.maps.event.addListener(map, 'click',
      function(event) {
       if (Marker){Marker.setMap(null)};
       Marker = new google.maps.Marker({
        position: event.latLng,
        draggable: true,
        map: map
       });
       infotable(Marker.getPosition().lat(),
       Marker.getPosition().lng(),map.getZoom());
       geocode();
       //マーカードラッグイベントの登録
       google.maps.event.addListener(Marker,'dragend',
        function(event) {
        infotable(Marker.getPosition().lat(),
        Marker.getPosition().lng(),map.getZoom());
        geocode();
       })
       //地図ズームチェンジイベントの登録
       google.maps.event.addListener(map, 'zoom_changed',
        function(event) {
        infotable(Marker.getPosition().lat(),
        Marker.getPosition().lng(),map.getZoom());
       })
      })
     //ジオコーディング
      function geocode(){  var geocoder = new google.maps.Geocoder();
       geocoder.geocode({ 'location': Marker.getPosition()}, 
          function(results, status) {
        if (status == google.maps.GeocoderStatus.OK && results[0]){
          document.getElementById('id_address').innerHTML = 
              results[0].formatted_address.replace(/^日本, /, '');
        }else{
          document.getElementById('id_address').innerHTML = 
            "Geocode 取得に失敗しました";
         alert("Geocode 取得に失敗しました reason: "
                + status);
        }
       });
      }
     
     //HTMLtagを更新
      function infotable(ido,keido,level){
       document.getElementById('id_ido').innerHTML = ido;
       document.getElementById('id_keido').innerHTML = keido;
       document.getElementById('id_address').innerHTML = level;
       document.getElementById("waypoint1").value =   ido + ","+ keido;
      }
     
    }

    function getCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const currentLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            // Set center and add marker
            map.setCenter(currentLocation);
            addCurrentLocationMarker(currentLocation);

            // Set the start input value
            //document.getElementById("start").value = "現在地" ;
            document.getElementById("start").value = currentLocation.lat + ", " + currentLocation.lng;
          },
          () => {
            console.error("Error getting current location");
          }
        );
      } else {
        console.error("Geolocation is not supported by this browser");
      }
    }

    function addCurrentLocationMarker(location) {
      // Remove existing marker if any
      if (currentLocationMarker) {
        currentLocationMarker.setMap(null);
      }

      // Add marker
      currentLocationMarker = new google.maps.Marker({
        position: location,
        map: map,
        title: "Current Location",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: "#4285F4",
          fillOpacity: 1,
          strokeColor: "#ffffff",
          strokeWeight: 2,
        },
      });
    }

    function calculateAndDisplayRoute() {
      const start = document.getElementById("start").value;
      const waypoint1 = document.getElementById("waypoint1").value;
      const waypoint2 = document.getElementById("waypoint2").value;
      const end = document.getElementById("end").value;
      const departureTime = document.getElementById("departure-time").value;

      const drivingMode = document.getElementById("mode-driving").checked;
      // const transitMode = document.getElementById("mode-transit").checked; 
      const walkingMode = document.getElementById("mode-walking").checked;
      const bicyclingMode = document.getElementById("mode-bicycling").checked;

      const travelModes = [];
      if (drivingMode) travelModes.push(google.maps.TravelMode.DRIVING);
      // if (transitMode) travelModes.push(google.maps.TravelMode.TRANSIT);
      if (walkingMode) travelModes.push(google.maps.TravelMode.WALKING);
      if (bicyclingMode) travelModes.push(google.maps.TravelMode.BICYCLING);

      const request = {
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.DRIVING, // Default mode
      };

      if (waypoint1) {
        request.waypoints = [{ location: waypoint1 }];
      }
      if (waypoint2) {
        if (!request.waypoints) request.waypoints = [];
        request.waypoints.push({ location: waypoint2 });
      }
      if (travelModes.length > 0) {
        request.travelMode = travelModes[0];
        request.transitOptions = {
          modes: travelModes.slice(1),
          departureTime: new Date(departureTime),
        };
      }

      directionsService.route(request, (response, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(response);
          showRouteInformation(response);
        } else {
          window.alert("Directions request failed due to " + status);
        }
      });
    }

    function showRouteInformation(response) {
      const directionsPanel = document.getElementById("details-tab");
      directionsPanel.innerHTML = "";

      for (let i = 0; i < response.routes.length; i++) {
        const route = response.routes[i];

        const summary = document.createElement("div");
        summary.innerHTML = `<b>${route.summary}</b>`;
        directionsPanel.appendChild(summary);

        const steps = route.legs[0].steps;
        for (let j = 0; j < steps.length; j++) {
          const stepInfo = document.createElement("div");
          stepInfo.innerHTML = steps[j].instructions;
          directionsPanel.appendChild(stepInfo);
        }
      }
    }

    function toggleDirectionsPanel() {
      const directionsPanel = document.getElementById("directions-panel");
      directionsPanel.classList.toggle("collapsed");
    }

    function toggleTab(tabName) {
      const contentTab = document.getElementById("content-tab");
      const detailsTab = document.getElementById("details-tab");

      if (tabName === "content") {
        contentTab.classList.add("active");
        detailsTab.classList.remove("active");
      } else {
        contentTab.classList.remove("active");
        detailsTab.classList.add("active");
      }
    }  
  </script>
</body>
</html>
